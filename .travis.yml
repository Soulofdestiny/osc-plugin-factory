matrix:
  include:
    - env: TEST_SUITE=distribution
      sudo: required
      services:
        - docker
      language: bash
      before_install:
        - |
          # Always run on custom branches in main project as diff does not work.
          if [ "$TRAVIS_BRANCH" == "master" ] || [ "$TRAVIS_PULL_REQUEST" != "false" ] ; then
            echo "Checking to see if skippable..."
            if ! git diff --name-only "$TRAVIS_COMMIT_RANGE" | grep -qE '^(\.travis.yml|dist\/.*)$' ; then
              echo "No distribution related changes, stopping build process."
              exit
            fi
          fi
        - docker build -f dist/ci/Dockerfile -t spec .
      script:
        - docker run --rm -it spec ./dist/ci/spec.sh
    - env: TEST_SUITE=nosetests
      sudo: false
      language: python
      python: 2.7
      install:
        # needed to install osc from git in requirements.txt
        - pip install pycurl urlgrabber
        - pip install -r requirements.txt
        - pip install python-coveralls
      script:
        - nosetests --with-coverage --cover-package=osclib --cover-inclusive
      after_success:
        - coveralls
    #- env: TEST_SUITE=obs
    - env: TEST_SUITE=backend
      sudo: required
      # TODO git clone obs and parse these lines
      # Possibly https://github.com/travis-ci/travis-yaml
      # perhaps build a docoker container that does all these things
      # TODO Install deps for other language environment
      language: ruby
      rvm: 2.4.1
      dist: trusty
      install:
        - (cd open-build-service/src/api && bundle install --jobs=3 --retry=3 --deployment --path=${BUNDLE_PATH:-vendor/bundle} --without=development)
      #gemfile: src/api/Gemfile
      script:
        - "(cd open-build-service/src/api && dist/ci/travis_script.sh $TEST_SUITE)"
      before_install:
        # TODO Last stable tag.
        - git clone https://github.com/openSUSE/open-build-service.git
        - open-build-service/dist/ci/travis_before_install.sh
      before_script: (cd open-build-service && dist/ci/travis_before_script.sh)
      #after_failure: (cd open-build-service && dist/ci/travis_after_failure.sh)
      #after_success:
        #- coveralls
      services:
        - memcached
